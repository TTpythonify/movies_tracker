<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movie Tracker - Home</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <!-- Navbar -->
    <nav>
        <h1>Movie Tracker</h1>
        <ul>
            <li><a href="#">Watch Later ({{ watchlist_count }})</a></li>
            <li><a href="#">Watched ({{ watched_count }})</a></li>
            <li><a href="#">Notifications</a></li>
            <li><a href="/">Logout</a></li>
        </ul>
    </nav>

    <!-- Welcome message -->
    <section class="welcome">
        <h2>Welcome, {{ username }}!</h2>
        <p>Search for your favorite movies and start tracking them.</p>
    </section>

    <!-- Main content -->
    <main>
        <div class="search-movies-box">
            <!-- Search Bar -->
            <div class="search-bar">
                <form action="/homepage" method="POST">
                    <input type="text" name="query" placeholder="Search movies..." required>
                    <button type="submit">Search</button>
                </form>
            </div>

            <!-- Movie Results -->
            <div class="movie-results">
                {% if movies %}
                    {% for movie in movies %}
                        <div class="movie-card">
                            <!-- Poster -->
                            {% if movie.poster_url %}
                                <img src="{{ movie.poster_url }}" alt="{{ movie.title }} poster">
                            {% else %}
                                <div class="placeholder-poster">No Image</div>
                            {% endif %}
                            
                            <!-- Movie Info -->
                            <div>
                                <h3>{{ movie.title }}</h3>
                                <p class="release-date">Release: {{ movie.release_date or 'N/A' }}</p>
                                <p class="overview">{{ movie.overview or 'No overview available.' }}</p>
                                <p class="ratings">⭐ {{ movie.vote_average or 0 }} | Votes: {{ movie.vote_count or 0 }}</p>
                                <button onclick="openMovieModal('{{ movie.id }}')">Details</button>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <p class="no-movies">No movies found. Start searching!</p>
                {% endif %}
            </div>
        </div>
    </main>

    <!-- Modal -->
    <div id="movieModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div id="message" style="display:none; color: green; margin: 10px 0; font-size: large;"></div>
            <div id="modalBody">
                <!-- Movie details will be loaded here -->
                <div class="loading">Loading...</div>
            </div>
        </div>
    </div>

    <script>
        // Get modal elements
        const modal = document.getElementById('movieModal');
        const span = document.getElementsByClassName('close')[0];
        const username = "{{ username }}";
        console.log("Logged-in user:", username);

        // Function to open modal and load movie details
        function openMovieModal(movieId) {
            modal.style.display = 'block';
            
            // Fetch movie details
            fetch(`/movie/${movieId}`)
                .then(response => response.json())
                .then(data => {
                    displayMovieDetails(data);
                })
                .catch(error => {
                    document.getElementById('modalBody').innerHTML = '<p>Error loading movie details.</p>';
                });
        }

        // Function to display movie details in modal
        function displayMovieDetails(movie) {
            const modalBody = document.getElementById('modalBody');
            modalBody.innerHTML = `
                <div class="modal-movie-details">
                    ${movie.backdrop_url ? `<img src="${movie.backdrop_url}" alt="${movie.title}" class="modal-backdrop">` : ''}
                    
                    <div class="modal-info-container">
                        ${movie.poster_url ? `<img src="${movie.poster_url}" alt="${movie.title}" class="modal-poster">` : '<div class="placeholder-poster">No Image</div>'}
                        
                        <div class="modal-text-info">
                            <h2>${movie.title}</h2>
                            <p class="modal-tagline">${movie.tagline || ''}</p>
                            <p class="modal-release"><strong>Release Date:</strong> ${movie.release_date || 'N/A'}</p>
                            <p class="modal-runtime"><strong>Runtime:</strong> ${movie.runtime ? movie.runtime + ' minutes' : 'N/A'}</p>
                            <p class="modal-rating">⭐ ${movie.vote_average || 0} / 10 (${movie.vote_count || 0} votes)</p>
                            <p class="modal-genres"><strong>Genres:</strong> ${movie.genres || 'N/A'}</p>
                            <p class="modal-overview"><strong>Overview:</strong><br>${movie.overview || 'No overview available.'}</p>
                            
                            <div class="modal-actions">
                                <button class="btn-watchlist" onclick="addToWatchlist(${movie.id})">Add to Watch Later</button>
                                <button class="btn-watched" onclick="addToWatched(${movie.id})">Mark as Watched</button>
                            </div>
                        </div>
                    </div>

                    <!-- Reviews Section -->
                    <div class="reviews-section">
                        <h3>User Reviews</h3>
                        
                        <!-- Add Review Form -->
                        <div class="add-review-form">
                            <textarea id="reviewText" placeholder="Write your review here..." rows="3"></textarea>
                            <button onclick="submitReview(${movie.id})" class="btn-submit-review">Submit Review</button>
                        </div>

                        <!-- Reviews List -->
                        <div class="reviews-list" id="reviewsList">
                            ${movie.reviews && movie.reviews.length > 0 
                                ? movie.reviews.map(review => `
                                    <div class="review-item">
                                        <div class="review-header">
                                            <strong>${review.username}</strong>
                                            <span class="review-date">${review.date}</span>
                                        </div>
                                        <p class="review-text">${review.reviewText}</p>
                                    </div>
                                `).join('')
                                : '<p class="no-reviews">No reviews yet. Be the first to review!</p>'
                            }
                        </div>
                    </div>
                </div>
            `;
        }

        // Close modal when X is clicked
        span.onclick = function() {
            modal.style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }

        // Function to add to watchlist
        function addToWatchlist(movieId) {
            fetch('/add_to_watchlist', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ movieId: movieId, username: username })
                })
                .then(response => response.json())
                .then(data => {
                    const msgDiv = document.getElementById('message');
                    msgDiv.textContent = data.message;
                    msgDiv.style.display = 'block';
                    msgDiv.classList.add('show-message');

                    setTimeout(() => {
                        msgDiv.style.display = 'none';
                        msgDiv.classList.remove('show-message');
                    }, 3000);
                })
                .catch(error => console.error('Error:', error));
        }   

        function addToWatched(movieId) {
            fetch('/add_to_watched', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ movieId: movieId, username: username })
                })
                .then(response => response.json())
                .then(data => {
                    const msgDiv = document.getElementById('message');
                    msgDiv.textContent = data.message;
                    msgDiv.style.display = 'block';
                    msgDiv.classList.add('show-message');

                    setTimeout(() => {
                        msgDiv.style.display = 'none';
                        msgDiv.classList.remove('show-message');
                    }, 3000);
                })
                .catch(error => console.error('Error:', error));
        }

        // Function to submit review
        function submitReview(movieId) {
            const reviewText = document.getElementById('reviewText').value.trim();
            if (!reviewText) {
                alert('Please write a review first!');
                return;
            }

            const currentDate = new Date().toISOString().split('T')[0];

            fetch('/submit_reviews', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    reviewText: reviewText,
                    username: username,
                    date: currentDate,
                    movieId: movieId
                })
            })
            .then(response => response.json())
            .then(data => {
                const msgDiv = document.getElementById('message');
                msgDiv.textContent = data.message;
                msgDiv.style.display = 'block';
                msgDiv.classList.add('show-message');

                document.getElementById('reviewText').value = '';

                // Reload movie details to show new review
                fetch(`/movie/${movieId}`)
                    .then(response => response.json())
                    .then(movieData => {
                        displayMovieDetails(movieData);
                    });

                setTimeout(() => {
                    msgDiv.style.display = 'none';
                    msgDiv.classList.remove('show-message');
                }, 3000);
            })
            .catch(error => console.error('Error:', error));
        }
    </script>
</body>
</html>